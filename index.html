<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Step Around Bogor - Virtual Tour Guide AR</title>
    
    <!-- Three.js (required by AR.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- A-Frame Library -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    
    <!-- AR.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe-ar.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #000;
        }

        /* ===================== SPLASH SCREEN ===================== */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #006b3c 0%, #004d2a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            gap: 30px;
        }

        .splash-logo {
            width: 120px;
            height: 120px;
            background: #ff8c00;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            font-weight: bold;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .splash-text {
            color: white;
            text-align: center;
        }

        .splash-text h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .splash-text p {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
        }

        .progress-container {
            width: 250px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff8c00, #ffb347);
            border-radius: 10px;
            width: 0%;
            animation: progress 3.5s ease-out forwards;
        }

        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .loading-text {
            color: white;
            font-size: 14px;
            opacity: 0.8;
            margin-top: 10px;
        }

        /* ===================== CAMERA PERMISSION PROMPT ===================== */
        #permissionAlert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #ff8c00;
            z-index: 10000;
            text-align: center;
            display: none;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        #permissionAlert.show {
            display: block;
        }

        #permissionAlert h2 {
            color: #ff8c00;
            margin-bottom: 15px;
            font-size: 20px;
        }

        #permissionAlert p {
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: #ccc;
        }

        #permissionAlert button {
            padding: 12px 30px;
            margin: 0 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-allow {
            background: #ff8c00;
            color: #006b3c;
        }

        .btn-allow:hover {
            background: #ffb347;
            transform: scale(1.05);
        }

        /* ===================== NAVIGATION OVERLAY ===================== */
        .navigation-overlay {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.75);
            color: #ff8c00;
            padding: 20px 25px;
            border-radius: 15px;
            border: 2px solid #ff8c00;
            z-index: 1000;
            display: none;
            min-width: 280px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .navigation-overlay.active {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .nav-instruction {
            font-size: 18px;
            margin-bottom: 12px;
            color: #ff8c00;
        }

        .distance-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px 0;
            border-top: 1px solid rgba(255, 140, 0, 0.3);
            border-bottom: 1px solid rgba(255, 140, 0, 0.3);
        }

        .distance-label {
            font-size: 12px;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .distance-value {
            font-size: 20px;
            color: #ff8c00;
            font-weight: 700;
        }

        .map-button {
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            background: #ff8c00;
            color: #006b3c;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .map-button:hover {
            background: #ffb347;
            transform: scale(1.05);
        }

        /* ===================== EDUCATION PANEL ===================== */
        .education-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            max-width: 380px;
            background: rgba(0, 107, 60, 0.92);
            color: white;
            padding: 25px;
            border-radius: 20px 20px 0 0;
            z-index: 1000;
            display: none;
            max-height: 45vh;
            overflow-y: auto;
            border: 2px solid #ff8c00;
            backdrop-filter: blur(10px);
            box-shadow: -5px -5px 20px rgba(0, 0, 0, 0.5);
        }

        .education-panel.active {
            display: block;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .panel-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #ff8c00;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .panel-description {
            font-size: 14px;
            line-height: 1.6;
            color: #e0e0e0;
        }

        .panel-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff8c00;
            color: #006b3c;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: 700;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .panel-close:hover {
            background: #ffb347;
            transform: rotate(90deg);
        }

        /* ===================== STATUS INDICATOR ===================== */
        .status-indicator {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.75);
            color: #ff8c00;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 999;
            display: none;
            border: 1px solid #ff8c00;
            backdrop-filter: blur(10px);
        }

        .status-indicator.active {
            display: block;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ===================== RESPONSIVE DESIGN ===================== */
        @media (max-width: 768px) {
            .navigation-overlay {
                top: 20px;
                left: 20px;
                min-width: 240px;
                padding: 15px 20px;
            }

            .education-panel {
                max-width: 100%;
                padding: 20px;
            }

            .splash-text h1 {
                font-size: 24px;
            }

            .panel-title {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .splash-logo {
                width: 90px;
                height: 90px;
                font-size: 45px;
            }

            .splash-text h1 {
                font-size: 20px;
            }

            .navigation-overlay {
                top: 15px;
                left: 15px;
                min-width: auto;
                padding: 12px 15px;
            }

            .nav-instruction {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- SPLASH SCREEN -->
    <div id="splashScreen">
        <div class="splash-logo">üöÄ</div>
        <div class="splash-text">
            <h1>Step Around Bogor</h1>
            <p>Your Virtual Tour Guide Solution Using AR</p>
        </div>
        <div class="progress-container">
            <div class="progress-bar"></div>
        </div>
        <div class="loading-text">Loading AR Experience...</div>
    </div>

    <!-- PERMISSION ALERT -->
    <div id="permissionAlert">
        <h2>üì∑ Camera Access Required</h2>
        <p>Step Around Bogor memerlukan akses kamera untuk pengalaman AR. Silakan izinkan akses kamera di browser Anda.</p>
        <button class="btn-allow" onclick="requestCameraPermission()">Allow Camera</button>
    </div>

    <!-- AR SCENE -->
    <a-scene 
        id="arScene"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: color_and_matrix; matrixCodeType: 3x3; maxDetectionRate: 60"
        vr-mode-ui="enabled: false"
    >
        <!-- Camera -->
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- Marker for Taman Mexico (using hiro preset) -->
        <a-marker
            id="mexicoMarker"
            preset="hiro"
            emitevents="true"
            raycaster="objects: .clickable"
        >
            <!-- Image display -->
            <a-image
                id="mexicoImage"
                src="assets/fotomexico.jpeg"
                position="0 0 0"
                scale="2 1.3 1"
                rotation="0 0 0"
            ></a-image>

            <!-- 3D Card background -->
            <a-box
                position="0 -0.5 -0.1"
                scale="2.5 1.8 0.1"
                color="#ffffff"
                opacity="0.95"
            ></a-box>

            <!-- Title sign -->
            <a-plane
                position="0 0.8 0.05"
                scale="2.2 0.6 1"
                color="#006b3c"
            ></a-plane>

            <a-text
                value="üåµ Taman Mexico"
                position="0 0.8 0.1"
                scale="1.5 1.5 1"
                color="#ff8c00"
                align="center"
                anchor="center"
            ></a-text>
        </a-marker>

        <!-- Kanji marker -->
        <a-marker
            id="kanji-marker"
            type="pattern"
            url="https://cdn.jsdelivr.net/npm/ar.js@3/data/data/kanji/pattern-kanji.patt"
            emitevents="true"
        >
            <a-sphere position="0 0.5 0" radius="0.5" color="#006b3c"></a-sphere>
        </a-marker>
    </a-scene>

    <!-- NAVIGATION OVERLAY -->
    <div class="navigation-overlay" id="navigationOverlay">
        <div class="nav-instruction" id="navInstruction">Turn Right 30m</div>
        <div class="distance-indicator">
            <span class="distance-label">Distance</span>
            <span class="distance-value" id="distanceValue">0.0 km</span>
        </div>
        <button class="map-button" id="mapButton" onclick="openMaps()">
            <span>üìç</span>
            Open in Google Maps
        </button>
    </div>

    <!-- EDUCATION PANEL -->
    <div class="education-panel" id="educationPanel">
        <button class="panel-close" onclick="closeEducationPanel()">√ó</button>
        <div class="panel-title" id="panelTitle">TAMAN MEXICO</div>
        <div class="panel-description" id="panelDescription">
            Mexican Garden adalah wahana edukasi untuk koleksi, konservasi, dan riset berbagai jenis kaktus dan sukulen di Kebun Raya Bogor.
        </div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.2);">
            <p style="font-size: 13px; color: #ccc;">üìç Taman Mexico, Kebun Raya Bogor, Jawa Barat</p>
        </div>
    </div>

    <!-- STATUS INDICATOR -->
    <div class="status-indicator" id="statusIndicator">
        <span class="status-dot"></span>
        <span id="statusText">Initializing...</span>
    </div>

    <script>
        // ===================== CONFIG =====================
        const TAMAN_MEXICO_COORDS = {
            lat: -6.5976,
            lng: 106.7995
        };

        const DESTINATIONS = {
            mexico: {
                name: 'TAMAN MEXICO',
                description: 'Mexican Garden adalah wahana edukasi untuk koleksi, konservasi, dan riset berbagai jenis kaktus dan sukulen di Kebun Raya Bogor. Tempat ini didedikasikan untuk konservasi dan riset tanaman sukulen dari berbagai belahan dunia.',
                coords: TAMAN_MEXICO_COORDS,
                instruction: 'Turn Right 30m',
                images: [
                    'https://images.unsplash.com/photo-1585868481888-b1409b04b423?w=400&h=300&fit=crop',
                    'https://images.unsplash.com/photo-1599599810694-b5ac4dd33c86?w=400&h=300&fit=crop'
                ]
            },
            orchid: {
                name: 'GRIYA ANGGREK',
                description: 'Griya Anggrek adalah wahana wisata edukasi untuk koleksi, konservasi, dan riset berbagai jenis anggrek, baik spesies asli Indonesia maupun hibrida.',
                coords: { lat: -6.5972, lng: 106.8005 },
                instruction: 'Go Straight 50m',
                images: [
                    'https://images.unsplash.com/photo-1585868481888-b1409b04b423?w=400&h=300&fit=crop'
                ]
            }
        };

        let userCoords = null;
        let isARActive = false;
        let currentMarker = null;
        let sceneReady = false;

        // ===================== PERMISSION HANDLING =====================
        async function requestCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                stream.getTracks().forEach(track => track.stop());
                
                document.getElementById('permissionAlert').classList.remove('show');
                console.log('‚úì Camera permission granted');
                initializeAR();
            } catch (error) {
                console.error('‚ùå Camera permission denied:', error);
                alert('Camera access is required for AR experience');
            }
        }

        // ===================== SPLASH SCREEN LOGIC =====================
        function hideSplashScreen() {
            const splash = document.getElementById('splashScreen');
            splash.style.opacity = '0';
            splash.style.transition = 'opacity 0.5s ease-out';
            setTimeout(() => {
                splash.style.display = 'none';
            }, 500);
        }

        // ===================== SCENE INITIALIZATION =====================
        function initializeAR() {
            console.log('üöÄ Initializing AR Scene...');
            
            const arScene = document.getElementById('arScene');
            
            // Wait for scene to be loaded
            if (arScene.hasLoaded) {
                onSceneLoaded();
            } else {
                arScene.addEventListener('loaded', onSceneLoaded);
            }
        }

        function onSceneLoaded() {
            console.log('‚úì A-Frame Scene Loaded');
            sceneReady = true;
            
            // Get geolocation
            initializeGeolocation();
            
            // Setup marker events
            setupMarkerEvents();
            
            // Show AR scene
            const arScene = document.getElementById('arScene');
            arScene.style.display = 'block';
            isARActive = true;
            
            // Hide splash after short delay
            setTimeout(hideSplashScreen, 3500);
            updateStatus('AR Ready - Scan Marker');
        }

        // ===================== GEOLOCATION =====================
        function initializeGeolocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userCoords = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('üìç User location:', userCoords);
                        updateStatus('Location acquired');
                    },
                    (error) => {
                        console.warn('üìç Using mock location');
                        userCoords = { lat: -6.5970, lng: 106.7990 };
                        updateStatus('Using demo location');
                    }
                );
            } else {
                userCoords = { lat: -6.5970, lng: 106.7990 };
            }
        }

        // ===================== MARKER DETECTION =====================
        function setupMarkerEvents() {
            const mexicoMarker = document.getElementById('mexicoMarker');
            
            mexicoMarker.addEventListener('markerFound', () => {
                console.log('‚úì Mexico Marker Detected!');
                currentMarker = 'mexico';
                showAROverlays('mexico');
                updateStatus('Marker Found');
            });

            mexicoMarker.addEventListener('markerLost', () => {
                console.log('‚úó Marker Lost');
                currentMarker = null;
                hideAROverlays();
                updateStatus('Scan Marker');
            });
        }

        // ===================== OVERLAY MANAGEMENT =====================
        function showAROverlays(destinationKey) {
            const dest = DESTINATIONS[destinationKey];
            if (!dest) return;

            document.getElementById('navInstruction').textContent = dest.instruction;
            document.getElementById('navigationOverlay').classList.add('active');

            document.getElementById('panelTitle').textContent = dest.name;
            document.getElementById('panelDescription').textContent = dest.description;
            document.getElementById('educationPanel').classList.add('active');

            // Update AR model with destination images
            updateARModel(dest);

            updateDistance(dest.coords);

            if (window.distanceInterval) clearInterval(window.distanceInterval);
            window.distanceInterval = setInterval(() => {
                updateDistance(dest.coords);
            }, 1000);
        }

        function updateARModel(dest) {
            const mexicoImage = document.getElementById('mexicoImage');
            if (mexicoImage && dest.images && dest.images.length > 0) {
                mexicoImage.setAttribute('src', dest.images[0]);
            }

            // Rotate 3D model
            const mexicoMarker = document.getElementById('mexicoMarker');
            if (mexicoMarker && mexicoMarker.object3D) {
                const rotation = mexicoMarker.object3D.rotation;
                mexicoMarker.object3D.rotation.set(rotation.x, rotation.y + 0.01, rotation.z);
            }
        }

        function hideAROverlays() {
            document.getElementById('navigationOverlay').classList.remove('active');
            document.getElementById('educationPanel').classList.remove('active');
            if (window.distanceInterval) {
                clearInterval(window.distanceInterval);
            }
        }

        function closeEducationPanel() {
            document.getElementById('educationPanel').classList.remove('active');
        }

        // ===================== DISTANCE CALCULATION =====================
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateDistance(destCoords) {
            if (!userCoords) return;

            const distance = calculateDistance(
                userCoords.lat,
                userCoords.lng,
                destCoords.lat,
                destCoords.lng
            );

            const distanceText = distance < 1 
                ? (distance * 1000).toFixed(0) + ' m'
                : distance.toFixed(2) + ' km';

            document.getElementById('distanceValue').textContent = distanceText;
        }

        // ===================== MAPS INTEGRATION =====================
        function openMaps() {
            if (!currentMarker) return;
            const dest = DESTINATIONS[currentMarker];
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${dest.coords.lat},${dest.coords.lng}`;
            window.open(mapsUrl, '_blank');
        }

        // ===================== STATUS =====================
        function updateStatus(text) {
            const statusInd = document.getElementById('statusIndicator');
            document.getElementById('statusText').textContent = text;
            statusInd.classList.add('active');
        }

        // ===================== START =====================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üì± Step Around Bogor - Checking permissions...');
            
            // Check if camera permission is already granted
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'camera' }).then(result => {
                    if (result.state === 'granted') {
                        document.getElementById('splashScreen').style.display = 'flex';
                        setTimeout(() => {
                            document.getElementById('splashScreen').style.display = 'none';
                            initializeAR();
                        }, 3500);
                    } else if (result.state === 'prompt') {
                        document.getElementById('splashScreen').style.display = 'flex';
                        setTimeout(() => {
                            document.getElementById('permissionAlert').classList.add('show');
                        }, 3500);
                    } else {
                        document.getElementById('permissionAlert').classList.add('show');
                    }
                });
            } else {
                // Fallback: just try to initialize
                document.getElementById('splashScreen').style.display = 'flex';
                setTimeout(() => {
                    initializeAR();
                }, 3500);
            }
        });

        window.addEventListener('beforeunload', () => {
            if (window.distanceInterval) clearInterval(window.distanceInterval);
        });
    </script>
</body>
</html>
